--- 
title: "现代统计图形（第二版）"
subtitle: "Modern Statistical Graphics (Second Edition)"
author: "黄湘云"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
papersize: b5
fontsize: 10pt
graphics: yes
colorlinks: yes
lot: yes
lof: yes
geometry:
  - tmargin=2.5cm
  - bmargin=2.5cm
  - lmargin=3.0cm
  - rmargin=2.0cm
classoption: "UTF8,twoside,openany,table"
hyperrefoptions:
  - linktoc=all
  - pdfstartview=FitH
  - bookmarksnumbered=true
subject: "统计图形"
keywords: 
  - R 语言
link-citations: yes
bibliography: 
  - book.bib
url: https://bookdown.org/xiangyun/msg2
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  这里是本书摘要.
biblio-style: gbt7714-numerical
natbiboptions: "sort,compress,super,square"
csl: china-national-standard-gb-t-7714-2015-author-date.csl
---

\mainmatter

```{r, echo=FALSE}
source(file = "_common.R")
```

# 欢迎 {#welcome .unnumbered}
\chaptermark{欢迎}

::: {.rmdwarn data-latex="{警告}"}
本书是《现代统计图形》[@msg2021] 的后续第二版，尚处于草创阶段。
:::


## 排版约定 {#convention .unnumbered}

\index{showtext}

书中的代码字体采用美观的 [Source Code Pro](https://ctan.org/pkg/sourcecodepro) 字体，
为方便跨操作系统编译书籍电子版，正文的中文字体采用开源的 [fandol](https://ctan.org/pkg/fandol) 字体。
而本书图形中使用的 Noto 系列中英文字体来自 [Google Fonts 字体库](https://fonts.google.com/)，分别是 Noto Sans 无衬线英文字体和 Noto Serif SC 宋体中文字体。图\@ref(fig:noto-fonts) 中的左、右子图分别展示 Base R 和 ggplot2 [@Wickham2016] 图形中中英文字体的效果。在图形中调用中文字体分两步走，先使用 **sysfonts** 包获取并注册 Noto 相关字体，然后在绘图的时候指定字体，并在代码块选项中启用 `fig.showtext=TRUE`，这样就能在 R Markdown 环境中优雅地绘制含中文的图形。如果在 R Console 中绘图则需加载 **showtext** 包，运行函数 `showtext_auto()`。

```{r noto-fonts, par=TRUE, fig.cap="中英文字体设置", fig.subcap=c('Base R 图形', 'ggplot2 图形'), out.width='50%', fig.width=4.5, fig.height=3.5, fig.alt='汞蒸气的压力随温度的指数级变化', fig.showtext=TRUE, fig.ncol=2}
# 准备 Noto 中英文字体
# sysfonts::font_add_google(name = "Noto Sans")
# sysfonts::font_add_google(name = "Noto Serif SC")
# 在 Base R 图形中使用 Noto 字体
plot(pressure, type = "b", pch = 19, ann = FALSE, family = "sans")
title(xlab = "温度", ylab = "压力", family = "source-han-serif-cn")
# 在 ggplot2 图形中使用 Noto 字体
library(ggplot2)
ggplot(data = pressure, aes(x = temperature, y = pressure)) +
  geom_line() +
  geom_point(size = 2) +
  labs(x = "温度", y = "压力") +
  scale_x_continuous(breaks = seq(0, 400, by = 50)) +
  theme_bw(base_size = 13) +
  theme(
    axis.title = element_text(family = "source-han-serif-cn"),
    axis.title.x = element_text(
      margin = margin(b = 0, l = 0, t = 20, r = 0)
    ),
    axis.title.y = element_text(
      margin = margin(b = 0, l = 0, t = 0, r = 20)
    ),
    panel.border = element_rect(color = "black"),
    panel.grid = element_blank(),
    axis.ticks.length = unit(0.25, "cm"),
    axis.text.x = element_text(
      family = "sans", color = "black",
      vjust = -1.5, size = rel(1.25)
    ),
    axis.text.y = element_text(
      family = "sans", color = "black",
      angle = 90, vjust = 1.5, hjust = 0.5,
      size = rel(1.25)
    )
  )
```

图\@ref(fig:noto-fonts) 所用数据集 pressure 来自 Base R 自带的 **datasets** 包，描述汞蒸气压力（以毫米计）随温度（以摄氏度计）的变化。为美观起见，除了设置字体外，右图以黑白主题替换了默认的灰色主题，调整了横、纵坐标轴标题到坐标轴的距离，面板边界线从灰色调为黑色，取消背景网格线，轴须增加至0.25厘米，适当增加了刻度标签的大小和位置。再和原始的 ggplot2 的图形对比，如图 \@ref(fig:noto-fonts-ugly) 所示，美颜前后已不可同日而语，能解决最重要的 20\% 细节问题就能让整个档次显著提升，达到让大多数人认可的水准。当然，一味地追求统一 Base R 风格或 ggplot2 风格是没有必要的，举此例也无意宣扬 Base R 绘图的简便，展示 ggplot2 绘图的复杂，简便和复杂往往不是由工具决定的，而是数据本身和工具使用的场景。将错误的工具放在错误的数据上，除了能带来实现上的技术挑战，造出一堆难以理解的图形垃圾，还可能误导受众。

```{r noto-fonts-ugly, fig.cap="ggplot2 默认的风格", out.width='60%', fig.width=4.5, fig.height=3.5, fig.showtext=TRUE, echo=FALSE}
# https://github.com/Mikata-Project/ggthemr
# 书籍就绪后，考虑统一颜色主题
ggplot(data = pressure, aes(x = temperature, y = pressure)) +
  geom_line() +
  geom_point() +
  labs(x = "温度", y = "压力") +
  theme(
    axis.title = element_text(family = "source-han-serif-cn"),
    axis.text = element_text(family = "sans")
  )
```

图 \@ref(fig:xkcd-fonts) 是一幅手绘漫画风格的图形，展示了三种不同鸢尾花的萼片宽度和长度的关系，所用 iris 数据集也来自 Base R 自带的 **datasets** 包，由 Anderson Edgar 收集，最早见于 1935 年的文章，后被 Ronald Fisher 在研究分类问题时引用[@Fisher1936]，到如今，在机器学习的社区里，提及 iris 数据集，很多人只知 Fisher 不知 Anderson。

<!-- 
https://github.com/GuangchuangYu/ggimage 
纯粹为了玩
https://cosx.org/2017/03/ggimage
https://cosx.org/2014/01/showtext-interesting-fonts-and-graphs
-->

```{r xkcd-fonts, fig.cap="手绘漫画风格的图形", out.width="75%", fig.width=5, fig.height=3, echo=FALSE, fig.showtext=TRUE}
# brew tap homebrew/cask-fonts
# brew install --cask font-xkcd
sysfonts::font_add("xkcd", regular = "~/Library/Fonts/xkcd.otf")
ggplot(data = iris, aes(Sepal.Length, Sepal.Width)) +
  geom_point(aes(color = Species, shape = Species)) +
  scale_color_grey() +
  theme_bw(base_size = 13, base_family = "xkcd") +
  theme(
    panel.border = element_rect(color = "black"),
    panel.grid = element_blank()
  )
```

统计图形很重要的一个作用是揭示统计概念，这就要求不拘泥于抽象的严格数学表达，借助数值模拟，可视化等手段帮助读者发散思维，加深理解复杂的逻辑概念，建立统计直觉，正如顾恺之所言「以形写神，形神兼备」。下面仅以二项分布为例讲讲区间估计及其覆盖概率。众所周知，在置信水平为 $1 - \alpha$ 的情况下，二项分布 $\mathrm{Bin}(n,p)$ 的参数 $p$ （也叫成功概率）的 Wald 区间估计为 $(\hat{p} - Z_{1-\alpha/2} \sqrt{\hat{p}*(1-\hat{p})/n}, \hat{p} + Z_{1-\alpha/2} \sqrt{\hat{p}*(1-\hat{p})/n})$，这里 $n$ 为样本量，$Z_{1-\alpha/2}$ 为标准正态分布 $\mathcal{N}(0,1)$ 在 $1-\alpha/2$ 处的分位点，一般 $\alpha$ 取 0.05，进而 $Z_{1-\alpha/2} \approx 1.96$。用通俗的话说，有 $1 - \alpha$ 的把握确定参数真值 $p$ 在该估计区间内，可见区间估计的意义是解决点估计可靠性问题，但是可靠性和精度往往不能兼得。统计上，通常的做法是先给定可靠性，去尽可能提升精度，即给定置信水平，使估计区间的长度尽可能短，这就涉及到区间估计的方法问题。

下面通过数值模拟的方式辅助说明 Wald 和 Agresti-Coull 两种区间估计方法，现固定样本量 $n = 10$ 或 $n = 100$，重复抽样 1000 次，将参数 $p$ 以 0.01 的间隔离散化，从 0.01 取值到 0.99。已知给定参数 $p$，每次抽样都可以得到参数 $p$ 的估计值 $\hat{p}$ 及其置信区间，1000 次的重复抽样可以计算出来 1000 个置信区间，每个区间要么覆盖真值，要么没有覆盖真值，覆盖的比例可以近似为覆盖概率。
如图\@ref(fig:coverage) 所示，上下两个子图分别代表 Wald 和 Agresti-Coull 区间估计，纵坐标是覆盖概率，横坐标是参数 $p$ 的真值，图中黑虚线表示置信水平 $1-\alpha=0.95$，黑灰点线分别表示样本量 $n=10$ 和 $n=100$ 的模拟情况，不难看出，Wald 区间估计方法在小样本情况下表现很差，覆盖概率很少能达到置信水平的，而 Agresti-Coull 区间估计在 Wald 基础上添加了修正后，情况得到显著改善，详细的介绍见文献 @Blyth1960;@Lawrence2001;@Geyer2005 。此外，还有 Wilson 区间估计，也是用的更加广泛的，Base R 内置的二项比例检验函数 `prop.test()` 就是用该方法获得比例 $p$ 的区间估计[@Wilson1927]。

<!-- 
TODO：区间估计，置信带、检验的功效曲线 
列联分析 [@Fagerland2017]
-->

(ref:coverage) 二项分布 $\mathrm{Bin}(n,p)$ 参数 $p$ 的区间估计：覆盖概率随成功概率的变化

```{r coverage, fig.cap="(ref:coverage)", out.width='75%', fig.width=6, fig.height=6, fig.showtext=TRUE, echo=FALSE}
# Wald 覆盖
coverage_wald <- function(p = 0.1, n = 10, nsim = 1000) {
  phats <- rbinom(nsim, prob = p, size = n) / n
  ll <- phats - qnorm(1 - 0.05 / 2) * sqrt(phats * (1 - phats) / n)
  ul <- phats + qnorm(1 - 0.05 / 2) * sqrt(phats * (1 - phats) / n)
  mean(ll < p & ul > p)
}
# Agresti-Coull 覆盖
coverage_agresti <- function(p = 0.1, n = 10, nsim = 1000) {
  phats <- (rbinom(nsim, prob = p, size = n) + 2) / (n + 4)
  ll <- phats - qnorm(1 - 0.05 / 2) * sqrt(phats * (1 - phats) / n)
  ul <- phats + qnorm(1 - 0.05 / 2) * sqrt(phats * (1 - phats) / n)
  mean(ll < p & ul > p)
}

sim_dat <- transform(expand.grid(
  p = seq(0.01, 0.99, by = 0.01),
  n = c(10, 100),
  nsim = 1000,
  methods = c("Wald", "Agresti-Coull")
),
prob = ifelse(methods == "Wald",
  Vectorize(coverage_wald)(p = p, n = n, nsim = nsim),
  Vectorize(coverage_agresti)(p = p, n = n, nsim = nsim)
),
nsample = ifelse(n == 10, "n=10", "n=100")
)

ggplot(data = sim_dat, aes(x = p, y = prob, color = nsample)) +
  geom_point() +
  geom_path() +
  geom_hline(yintercept = 0.95, linetype = 2) +
  scale_color_grey() +
  facet_wrap(vars(methods), ncol = 1, scales = "free_y") +
  labs(x = "成功概率", y = "覆盖概率", color = "样本量") +
  theme_bw(base_size = 13, base_family = "sans") +
  theme(title = element_text(family = "source-han-serif-cn"))
```

::: {.rmdtip data-latex="{提示}"}
请读者再思考两个问题：图\@ref(fig:coverage) 为什么呈现对称的形式，泊松分布会和二项分布有类似的现象吗？如果有的话，连续分布，如正态分布和指数分布也会有吗？
:::

散点图\@ref(fig:faithful-bkde2d) 展示美国怀俄明州黄石国家公园[老忠实间歇泉](https://en.wikipedia.org/wiki/Old_Faithful)喷发规律，横轴表示喷发持续时间（以分钟计），纵轴表示等待时间（以分钟计），点的亮暗程度（白到黑）代表附近点密度的高低，亮度值通过二维核密度估计方法得到，具体实现借助了 **KernSmooth** [@KernSmooth1995] 包提供的 `bkde2D()` 函数，设置了喷发时间的窗宽为 0.7 分钟，等待时间的窗宽为 7分钟。不难看出，每等待55分钟左右间歇泉喷发约2分钟，或者每等待80分钟左右间歇泉喷发4.5约分钟，非常守时，表现得很老实，故而得名。说实话，二维核密度估计在这里有点大材小用了，因为数据点比较少，肉眼也能分辨出来哪里聚集的点多，哪里聚集的点少。

```{r faithful-bkde2d, par=TRUE, fig.cap="二维核密度估计", echo=FALSE, fig.subcap=c('亮度/等值线表示核密度估计值', '等值线表示核密度估计值'), out.width='50%', fig.width=4.5, fig.height=4.5, fig.showtext=TRUE, fig.ncol=2, message=FALSE}
# faithful 添加二维核密度估计 density 列
library(KernSmooth)
den <- bkde2D(x = faithful, bandwidth = c(0.7, 7), gridsize = c(51L, 51L))
faithful2d <- expand.grid(eruptions = den$x1, waiting = den$x2) |>
  transform(density = as.vector(den$fhat))

plot(faithful, 
  pch = 20, panel.first = grid(), cex = 1, ann = FALSE, 
  col = densCols(faithful, bandwidth = c(0.7, 7), nbin = c(51L, 51L), colramp = gray.colors)
)
contour(den$x1, den$x2, den$fhat, add = TRUE)
title(xlab = "喷发时间", ylab = "等待时间", family = "source-han-serif-cn")

library(ggplot2)
library(colorspace)
ggplot() +
  geom_point(data = faithful, aes(x = eruptions, y = waiting), color = "gray60") +
  geom_contour(data = faithful2d, aes(
    x = eruptions, y = waiting,
    z = density, colour = after_stat(level)
  ), size = 1, show.legend = FALSE) +
  scale_colour_binned_sequential(palette = "Grays") +
  labs(x = "喷发时间", y = "等待时间", colour = "核密度值") +
  theme_bw(base_size = 13) +
  theme(
    legend.title = element_text(family = "source-han-serif-cn"),
    axis.title = element_text(family = "source-han-serif-cn"),
    axis.title.x = element_text(
      margin = margin(b = 0, l = 0, t = 20, r = 0)
    ),
    axis.title.y = element_text(
      margin = margin(b = 0, l = 0, t = 0, r = 20)
    ),
    panel.border = element_rect(color = "black"),
    panel.grid = element_blank(),
    axis.ticks.length = unit(0.25, "cm"),
    axis.text.x = element_text(
      family = "sans", color = "black",
      vjust = -1.5, size = rel(1.25)
    ),
    axis.text.y = element_text(
      family = "sans", color = "black",
      angle = 90, vjust = 1.5, hjust = 0.5,
      size = rel(1.25)
    )
  )
```


<!-- 
书籍第一版没有介绍 核密度估计 的原理，第二版中要予以介绍，做到知其然且知其所以然，
核密度估计方法在可视化中应用是相当广泛的 多维核平滑方法 [@Chacon2018]
计算统计
密度估计和二维平滑方法 https://cswr.nrhstat.org/
EM 算法、数值优化、随机优化等内容
Computational Statistics with R

老忠实泉全量数据集的图形补充，离线用本地数据集，在线用 netlify 数据集

https://msg2nd.netlify.app/data/Stephens.csv
https://msg2nd.netlify.app/data/Taylor.csv

topo 数据集空间统计 克里金插值 image 图 透视图  三维散点图

1991 年 [Jerome Friedman](https://statweb.stanford.edu/~jhf/) 提出多元适应性回归样条方法
Multivariate Adaptive Regression Splines http://www.milbo.users.sonic.net/earth/
-->

图 \@ref(fig:topo) 描述海拔高度随横纵坐标的变化，采样点是随机的，左图是散点图，右图是拟合曲面

```{r topo, fig.cap="海拔高度的变化", fig.subcap=c("三维散点图", "空间曲面"), fig.width=5.5, fig.height=5, fig.ncol=2, out.width="45%", echo=FALSE, fig.showtext=TRUE}
library(MASS)
library(lattice)
# 减少三维图形的边空
lattice.options(
  layout.widths = list(
    left.padding = list(x = -.6, units = "inches"),
    right.padding = list(x = -1.0, units = "inches")
  ),
  layout.heights = list(
    bottom.padding = list(x = -.8, units = "inches"),
    top.padding = list(x = -1.0, units = "inches")
  )
)

# trellis.par.get()
cloud(z ~ x * y,
  data = topo, pch = 19, col = "black",
  scales = list(arrows = FALSE, col = "black", z = list(rot = 90)),
  par.settings = list(
    axis.line = list(col = "transparent"),
    fontsize = list(text = 20, points = 10)
  ),
  screen = list(z = 120, x = -65, y = 0)
)

with(topo, {
  topo.lo <- loess(z ~ x * y,
    span = 1 / 3, parametric = "x",
    drop.square = "x", family = "symmetric"
  )
  topo.marginal <- list(
    x = seq(min(x), max(x), length.out = 25),
    y = seq(min(y), max(y), length.out = 25)
  )
  topo.grid <- expand.grid(topo.marginal)
  topo.fit <- predict(topo.lo, topo.grid)
  wireframe(topo.fit ~ topo.grid$x * topo.grid$y,
    shade = TRUE,
    screen = list(z = 120, x = -65, y = 0),
    scales = list(
      arrows = FALSE, col = "black",
      z = list(tick.number = 4, rot = 90)
    ),
    par.settings = list(
      axis.line = list(col = "transparent"),
      fontsize = list(text = 20, points = 10)
    ),
    xlab = "x", ylab = "y", zlab = "z"
  )
})
```


如读者所见，本书不会局限于作图的工具，除了上面已经展示的 Base R 和 **ggplot2**，还会陆续用到 **lattice** [@Sarkar2008] 和 [**rgl**](https://github.com/dmurdoch/rgl) 包，甚至会超出 R 语言的范畴，介绍 LaTeX 世界里的 [TikZ](https://ctan.org/pkg/pgf) 和 JavaScript 中的 WebGL 等。如图 \@ref(fig:linear-model)，因图形中包含数学公式和符号，为了获得原汁原味的渲染效果，在使用 Base R 绘图的过程中通过 [**tikzDevice**](https://github.com/daqana/tikzDevice) 包引入了 LaTeX 中的 TikZ 绘图引擎。众所周知，Donald Knuth 十年磨一剑，开发了 TeX 排版系统，就是解决排版数学公式的痛点。在掌握各类现代的绘图技术后，回归统计图形的落脚点，从数据传递的信息出发，选择合适的图形和实现工具，兼顾美观，到达「道」与「术」和谐统一的境界。


```{r linear-model, dev='tikz', fig.cap="简单线性模型", out.width="60%", fig.width=3, fig.height=3, cache=TRUE, fig.process=to_png, echo=FALSE}
opar <- par(no.readonly = TRUE)
on.exit(par(opar), add = TRUE)
par(mgp = c(2, 0.7, 0), mar = c(4, 3, 4, 1) + 0.1)
set.seed(2021)
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
lab <- sample(
  x = paste0("$\\mathcal{", LETTERS, "}$"),
  size = 10, replace = FALSE
)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y,
  main = "你好 \\LaTeX!", # 引入 7 号文本字体
  sub = "$\\mathcal{N}(x;\\mu,\\Sigma)$",
  xlab = "$x$", ylab = "$y$", type = "n"
)
text(x = x, y = y, labels = lab)
abline(model, col = "black")
# 引入 7 号数学字体
mtext(paste("线性模型: $\\mathsf{R}^{2}=", rsq, "$"), line = 0.5)
legend("bottomright",
  legend = paste0(
    "$y = ", round(coef(model)[2], 3), "x +",
    round(coef(model)[1], 3), "$"
  ),
  bty = "n"
)
```

`r if (knitr::is_latex_output()) '<!--'` 
Base R 内置的 R 包含有丰富的数据集，非常适合演示图形和阐述统计理论，后面技术和理论部分的介绍大多围绕内置的数据集展开，数据集及其描述如下表所示：

```{r core-datasets, echo=FALSE}
# 抽取 R 包信息
Pkgs <- sapply(list.files(R.home("library")), function(x) {
  packageDescription(pkg = x, fields = "Priority")
})
# 抽取内置 R 包列表
CorePkgs <- names(Pkgs[Pkgs %in% c("base", "recommended") & !is.na(Pkgs)])
# 抽取 R 包的数据集
BaseDataSets <- data(package = CorePkgs)$results[, c("Package", "Item", "Title")]

library(DT)
datatable(BaseDataSets,
  rownames = FALSE, # 不显示行名
  extensions = c("Buttons", "RowGroup"),
  options = list(
    pageLength = 10, # 每页显示的行数
    language = list(url = "//cdn.datatables.net/plug-ins/1.10.11/i18n/Chinese.json"), # 汉化
    dom = "Bfrtp", # 去掉显示行数 i、过滤 f 的能力，翻页用 p 表示
    ordering = F, # 去掉列排序
    buttons = c("copy", "csv", "excel", "print"), # 提供打印按钮
    rowGroup = list(dataSrc = 0), # 按 Package 列分组
    columnDefs = list(
      list(className = "dt-center", targets = 0), # 不显示行名，则 targets 从 0 开始，否则从 1 开始
      list(visible = FALSE, targets = 0) # 不显示 Package 列
    )
  ),
  caption = "Base R 包内置的数据集"
)
```

`r if (knitr::is_latex_output()) '-->'`

书中参考文献的样式一律遵守2015年国家颁布的《GB/T 7714-2015 信息与文献 参考文献著录规则》，全书使用作者年份引用格式，感谢胡振震开发的 [biblatex-gb7714-2015](https://github.com/hushidong/biblatex-gb7714-2015) 宏包，使参考文献的引用在 LaTeX 文档中变得更容易，解放了一部分排版编辑工作，让作者腾出时间专注于内容。

::: {.rmdnote data-latex="{注意}"}
为方便测试贡献者提供的 PR，本书托管在 Github 上，同时启用 Github Action 服务。书中使用的 Noto 系列字体来自 Google 字体网站，国内可能无法访问，但为了尽可能减少可重复的成本，保持书籍能够在 MacOS、Windows 和 Linux 等系统上顺利编译，字体要尽可能便携易得，此外，考虑到美观性，以及避免仓库中附带字体可能带来的权限问题，因此，在绘图程序中使用了 Noto 字体，暂时没有更好的办法。
:::

考虑到要同时支持 PDF 和 HTML 两种书籍格式，书中制作表格使用 **knitr** 和 [**kableExtra**](https://github.com/haozhu233/kableExtra) 包，为简单起见，提供一个迷你的表格样式示例，如表 \@ref(tab:iris-tab) 所示。截止写作时间，能够制作表格的 R 包其实有很多，比如 [DT](https://github.com/rstudio/DT)、[gt](https://github.com/rstudio/gt) 等[@xie2020]，但同时深度支持 PDF 和 HTML 两种输出格式且达到出版级水准的，只有 **kableExtra**，此处感谢朱昊为 R 社区作出的贡献！

\index{kableExtra}

```{r iris-tab, echo=FALSE}
library(knitr)
library(kableExtra)
kable(head(iris), caption = "iris 数据集（部分）", booktabs = TRUE) |> 
  kable_classic()
```

总而言之，本书将基于开源的工具和成熟的技术，提供简洁美观不失真意的可视化表达。欢迎各位读者参与贡献，甚至加入写作团队，成为主力创作者，虚位以待！如你所见，本书将大量使用开源的软件、字体、R 包和免费的服务，因此贡献的内容也应以此为基础，赋以独树一帜的洞见，优雅简洁的实现，过程稳定可重复，长期有耐心，坚信优质的内容必将持续为读者提供价值！

书籍开源在 Github 上，聪明的你如果准备参与创作，需要掌握一些基本的技能，以便大家展开协作。图\@ref(fig:skills)是一个简单的技能栈图，书稿以一个个 R Markdown 文件的形式存在，符合 bookdown 的组织方式，本地在 RStudio 里编辑和编译，线上在 GitHub Action 环境里编译成 HTML 和 PDF 格式，如果你还了解 LaTeX 或 Pandoc 就更好了，可以把本书做得更加漂亮。当然，工具可以不限于提到的这些，只要使着顺手，比如 [VS Code](https://code.visualstudio.com/)，它对 R 语言的支持也很好了，只要你懂各种配置，体验不比 RStudio 差。

```{r skills, engine="tikz", fig.cap="《现代统计图形》的技能栈", out.width="65%", echo=FALSE, cache=TRUE, engine.opts=list(extra.preamble=c("\\usepackage[default]{sourcesanspro}","\\usepackage[fontset=fandol]{ctex}", "\\usepackage{smartdiagram}"))}
\smartdiagramset{planet color=gray!40!white, uniform color list=gray!40!white for 10 items}
\smartdiagram[bubble diagram]{基础技能,
  编辑~\\ (RStudio), 组织~\\ (bookdown), 协作~\\ (Git), 排版~\\ (LaTeX/Pandoc), 编译~\\ (GitHub Action)}
```


## 软件信息 {#session-info .unnumbered}

<!-- 记号约定，注释，R 包环境管理，部署服务 -->

```{r ci-indicator, echo=FALSE}
ci <- identical(Sys.getenv("CI"), "true")
```

R 包名以粗体表示，如 **knitr** 包，函数名以等宽体表示，如 `plot()`，函数的参数名同理。代码块内注释用 `#` 表示，运行结果每一行开头以 `#>` 标记。本书写作过程中，依赖 **knitr** [@xie2015]、**rmarkdown** [@xie2018] 和 **bookdown** [@xie2016] 等众多 R 包，为方便管理，引入 [**renv**](https://github.com/rstudio/renv) 包将 R 包信息快照下来，存成一个 `renv.lock` 文件，同书稿一起存储在 Github 仓库内，方便读者复现本书内容。目前，书稿使用 `r R.version.string` 编译，你现在看到的是`r ifelse(ci, '在线', '离线')`编译版本，最新一次编译时间是 `r format(Sys.time(), tz = "Asia/Shanghai")`，直接使用的 R 包如下：

```{r package-info}
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "bookdown", "ggplot2", "kableExtra", 
  "showtext", "tikzDevice", "magick", "pdftools", "renv",
  "gapminder", "ggrepel", "rootSolve"
), dependencies = TRUE)
```
