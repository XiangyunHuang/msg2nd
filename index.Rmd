--- 
title: "现代统计图形（第二版）"
author: "黄湘云"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
papersize: b5
fontsize: 10pt
graphics: yes
colorlinks: yes
lot: yes
lof: yes
geometry:
  - tmargin=2.5cm
  - bmargin=2.5cm
  - lmargin=3.0cm
  - rmargin=2.0cm
classoption: "UTF8,twoside,openany,table"
hyperrefoptions:
  - linktoc=all
  - pdfstartview=FitH
  - bookmarksnumbered=true
link-citations: yes
bibliography: 
  - book.bib
url: https://bookdown.org/xiangyun/msg2
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  现代统计图形（第二版）.
biblio-style: gb7714-2015ay
biblatexoptions: 
  - backend=biber
  - gbpub=true
  - sorting=nyt
  - gbtype=false
csl: china-national-standard-gb-t-7714-2015-author-date.csl
---

\mainmatter

# 欢迎 {#welcome .unnumbered}

::: {.rmdwarning data-latex="{警告}"}
本书是《现代统计图形》[@msg2021] 的后续第二版，尚处于草创阶段。
:::

书中的代码字体采用美观的 [Source Code Pro](https://ctan.org/pkg/sourcecodepro) 字体，
为方便跨操作系统编译书籍电子版，正文的中文字体采用开源的 [fandol](https://ctan.org/pkg/fandol) 字体。
而本书图形中使用的 Noto 系列中英文字体来自 [Google Fonts 字体库](https://fonts.google.com/)，分别是 Noto Sans 无衬线英文字体和 Noto Serif SC 宋体中文字体。图\@ref(fig:noto-fonts) 中的左、右子图分别展示 Base R 和 ggplot2 [@Wickham2016] 图形中中英文字体的效果。在图形中调用中文字体分两步走，先使用 **sysfonts** 包获取并注册 Noto 相关字体，然后在绘图的时候指定字体，并在代码块选项中启用 `fig.showtext=TRUE`，这样就能在 R Markdown 环境中优雅地绘制含中文的图形。如果在 R Console 中绘图则需加载 **showtext** 包，运行函数 `showtext_auto()`。

```{r noto-fonts, fig.cap="中英文字体设置", fig.subcap=c('Base R 图形', 'ggplot2 图形'), out.width='50%', fig.width=4.5, fig.height=3.5, fig.align='center', fig.alt='汞蒸气的压力随温度的指数级变化', fig.showtext=TRUE, fig.ncol=2}
# 准备 Noto 中英文字体
sysfonts::font_add_google(name = "Noto Sans")
sysfonts::font_add_google(name = "Noto Serif SC")
# 在 Base R 图形中使用 Noto 字体
par(mar = c(4, 4, .2, .1), family = "Noto Sans")
plot(pressure, type = 'b', pch = 19, ann = FALSE)
title(xlab = "温度", ylab = "压力", family = "Noto Serif SC")
# 在 ggplot2 图形中使用 Noto 字体
library(ggplot2)
ggplot(data = pressure, aes(x = temperature, y = pressure)) +
  geom_line() +
  geom_point(size = 2) +
  labs(x = "温度", y = "压力") +
  scale_x_continuous(breaks = seq(0, 400, by = 50)) +
  theme_bw(base_size = 13) +
  theme(
    axis.title = element_text(family = "Noto Serif SC"),
    axis.title.x = element_text(
      margin = margin(b = 0, l = 0, t = 20, r = 0)
    ),
    axis.title.y = element_text(
      margin = margin(b = 0, l = 0, t = 0, r = 20)
    ),
    panel.border = element_rect(color = "black"),
    panel.grid = element_blank(),
    axis.ticks.length = unit(0.25, "cm"),
    axis.text.x = element_text(
      family = "Noto Sans", color = "black",
      vjust = -1.5, size = rel(1.25)
    ),
    axis.text.y = element_text(
      family = "Noto Sans", color = "black",
      angle = 90, vjust = 1.5, hjust = 0.5,
      size = rel(1.25)
    )
  )
```

图\@ref(fig:noto-fonts) 所用数据集 pressure 来自 Base R 自带的 **datasets** 包，描述汞蒸气压力（毫米）随温度（摄氏度）的变化。为美观起见，除了设置字体外，右图以黑白主题替换了默认的灰色主题，调整了横、纵坐标轴标题到坐标轴的距离，面板边界线从灰色调为黑色，取消背景网格线，轴须增加至0.25厘米，适当增加了刻度标签的大小和位置。再和原始的 ggplot2 的图形对比，如图 \@ref(fig:noto-fonts-ugly) 所示，美颜前后已不可同日而语，能解决最重要的 20\% 细节问题就能让整个档次显著提升，达到让大多数人认可的水准。当然，一味地追求统一 Base R 风格或 ggplot2 风格是没有必要的，举此例也无意宣扬 Base R 绘图的简便，展示 ggplot2 绘图的复杂，简便和复杂往往不是由工具决定的，而是数据本身和工具使用的场景。将错误的工具放在错误的数据上，除了能带来实现上的技术挑战，造出一堆难以理解的图形垃圾，还可能误导受众。

```{r noto-fonts-ugly, fig.cap="ggplot2 默认的风格", out.width='50%', fig.width=4.5, fig.height=3.5, fig.align='center', fig.showtext=TRUE, echo=FALSE}
ggplot(data = pressure, aes(x = temperature, y = pressure)) +
  geom_line() +
  geom_point() +
  labs(x = "温度", y = "压力") +
  theme(
    axis.title = element_text(family = "Noto Serif SC"),
    axis.text = element_text(family = "Noto Sans")
  )
```


如读者所见，本书不会局限于作图的工具，除了上面已经展示的 Base R 和 **ggplot2**，还会陆续用到 **lattice** [@Sarkar2008] 和 [**rgl**](https://github.com/dmurdoch/rgl) 包，甚至会超出 R 语言的范畴，介绍 LaTeX 世界里的 [TikZ](https://ctan.org/pkg/pgf) 和 JavaScript 中的 WebGL 等。如图 \@ref(fig:linear-model)，因图形中包含数学公式和符号，为了获得原汁原味的渲染效果，在使用 Base R 绘图的过程中通过 [**tikzDevice**](https://github.com/daqana/tikzDevice) 包引入了 LaTeX 中的 TikZ 绘图引擎。众所周知，Donald Knuth 十年磨一剑，开发了 TeX 排版系统，就是解决排版数学公式的痛点。在掌握各类现代的绘图技术后，回归统计图形的落脚点，从数据传递的信息出发，选择合适的图形和实现工具，兼顾美观，力求一图胜千言。


```{r linear-model, dev='tikz', fig.cap="简单线性模型", out.width="75%", fig.width=4, fig.height=4, cache=TRUE, fig.process=to_png, fig.align='center', echo=FALSE}
set.seed(2021)
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
lab <- sample(
  x = paste0("$\\mathcal{", LETTERS, "}$"),
  size = 10, replace = FALSE
)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y,
  main = "你好 \\LaTeX!", # 引入 7 号文本字体
  sub = "$\\mathcal{N}(x;\\mu,\\Sigma)$",
  xlab = "$x$", ylab = "$y$", type = "n"
)
text(x = x, y = y, labels = lab)
abline(model, col = "red")
# 引入 7 号数学字体
mtext(paste("线性模型: $\\mathsf{R}^{2}=", rsq, "$"), line = 0.5)
legend("bottomright",
  legend = paste0(
    "$y = ", round(coef(model)[2], 3), "x +",
    round(coef(model)[1], 3), "$"
  ),
  bty = "n"
)
```


书中参考文献的样式一律遵守2015年国家颁布的《GB/T 7714-2015 信息与文献 参考文献著录规则》，全书使用作者年份引用格式，感谢胡振震开发的 [biblatex-gb7714-2015](https://github.com/hushidong/biblatex-gb7714-2015) 宏包，使参考文献的引用在 LaTeX 文档中变得更容易，解放了一部分排版编辑工作，让作者腾出时间专注于内容。

::: {.rmdnote data-latex="{注意}"}
为方便测试贡献者提供的 PR，本书托管在 Github 上，同时启用 Github Action 服务。书中使用的 Noto 系列字体来自 Google 字体网站，国内可能无法访问，但为了尽可能减少可重复的成本，保持书籍能够在 MacOS、Windows 和 Linux 等系统上顺利编译，字体要尽可能便携易得，此外，考虑到美观性，以及避免仓库中附带字体可能带来的权限问题，因此，在绘图程序中使用了 Noto 字体，暂时没有更好的办法。
:::

考虑到要同时支持 PDF 和 HTML 两种书籍格式，书中制作表格采纳 **knitr** 和 [**kableExtra**](https://github.com/haozhu233/kableExtra) 的能力，为简单起见，提供一个迷你的表格样式示例，如表 \@ref(tab:iris-tab) 所示。截止写作时间，能够制作表格的 R 包有很多，但同时深度支持 PDF 和 HTML 两种输出格式且达到出版级水准的，只有 **kableExtra**，此处感谢朱昊为 R 社区作出的贡献！

```{r iris-tab}
library(knitr)
library(kableExtra)
kable(head(iris), caption = "iris 数据集（部分）", booktabs = TRUE) |> 
  kable_classic()
```

总而言之，本书将基于开源的工具和成熟的技术，提供简洁美观不失真意的可视化表达。欢迎各位读者参与贡献，甚至加入写作团队，成为主力创作者，虚位以待！如你所见，本书将大量使用开源的软件、字体、R 包和免费的服务，因此贡献的内容也应以此为基础，赋以独树一帜的洞见，优雅简洁的实现，过程稳定可重复，长期有耐心，坚信优质的内容必将持续为读者提供价值！

<!-- 耐心、用心、善心，如何参与具体的贡献 -->

## 软件信息 {#session-info .unnumbered}

<!-- 记号约定，注释，R 包环境管理，部署服务 -->

本书写作过程中，依赖 **knitr** [@xie2015]、**rmarkdown** [@xie2018; @xie2020] 和 **bookdown** [@xie2016]，书籍在 `r R.version.string` 下编译，最新一次编译时间是 `r format(Sys.time(), tz = "Asia/Shanghai")`，其它使用的 R 包如下：

```{r package-info}
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "bookdown", "ggplot2", "kableExtra", 
  "showtext", ""
))
```
